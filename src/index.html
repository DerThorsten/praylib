<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>raylib web game</title>

    <meta name="title" content="raylib web game">
    <meta name="description" content="New raylib web videogame, developed using raylib videogames library">
    <meta name="keywords" content="raylib, games, html5, programming, C, C++, library, learn, videogames">
    <meta name="viewport" content="width=device-width">

    <!-- Open Graph metatags for sharing -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="raylib web game">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image" content="https://www.raylib.com/common/raylib_logo.png">
    <meta property="og:image:alt" content="New raylib web videogame, developed using raylib videogames library" />
    <meta property="og:site_name" content="raylib - example">
    <meta property="og:url" content="https://www.raylib.com/games.html">
    <meta property="og:description" content="New raylib web videogame, developed using raylib videogames library">

    <!-- Twitter metatags for sharing -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@raysan5">
    <meta name="twitter:title" content="raylib web game">
    <meta name="twitter:image" content="https://www.raylib.com/common/raylib_logo.png">
    <meta name="twitter:image:alt" content="New raylib web videogame, developed using raylib videogames library">
    <meta name="twitter:url" content="https://www.raylib.com/games.html">
    <meta name="twitter:description" content="New raylib web videogame, developed using raylib videogames library">

    <!-- Favicon -->
    <link rel="shortcut icon" href="https://www.raylib.com/favicon.ico">

    <!-- Web Style -->
    <style>
        body { 
          margin: 0px; 
          overflow: hidden; 
          background-color: black;
        }
        canvas.emscripten { 
          border: 0px none; 
          background-color: black;}
          padding-left: 0;
          padding-right: 0;
          margin-left: auto;
          margin-right: auto;
          display: block;
        }
    </style>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/gh/eligrey/FileSaver.js/dist/FileSaver.min.js"> </script>
    <script type='text/javascript'>
        function saveFileFromMEMFSToDisk(memoryFSname, localFSname)     // This can be called by C/C++ code
        {
            var isSafari = false; // Not supported, navigator.userAgent access is being restricted
            //var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            var data = FS.readFile(memoryFSname);
            var blob;

            if (isSafari) blob = new Blob([data.buffer], { type: "application/octet-stream" });
            else blob = new Blob([data.buffer], { type: "application/octet-binary" });

            // NOTE: SaveAsDialog is a browser setting. For example, in Google Chrome,
            // in Settings/Advanced/Downloads section you have a setting:
            // 'Ask where to save each file before downloading' - which you can set true/false.
            // If you enable this setting it would always ask you and bring the SaveAsDialog
            saveAs(blob, localFSname);
        }
    </script>
    </head>
    <body>
        <canvas class=emscripten id=canvas oncontextmenu=event.preventDefault() tabindex=-1></canvas>
        <p id="output" />
        <script>
            var Module = {
                print: (function() {
                    var element = document.getElementById('output');
                    if (element) element.value = ''; // clear browser cache
                    return function(text) {
                        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                        console.log(text);
                        if (element) {
                          element.value += text + "\n";
                          element.scrollTop = element.scrollHeight; // focus on bottom
                        }
                    };
                })(),
                canvas: (function() {
                    var canvas = document.getElementById('canvas');
                    return canvas;
                })(),
                locateFile : function(filename){
                        if(filename.endsWith('praylib_host.wasm')){
                            return `./praylib_host.wasm`; // location of the wasm 
                                                            // file on the server relative 
                                                            // to the praylib_host.js file
                        }
                },
                /* addRunDependency: function (name){
                },
                removeRunDependency: function (name){
                }, */
            };
            globalThis.Module = Module; // Make Module globally accessible
        </script>
        <script src="praylib_host.js"></script>
        <script>
        async function runPyjs() {

            let pyjs = await createModule(globalThis.Module);
            await pyjs.bootstrap_from_empack_packed_environment(
                "./empack_env_meta.json", // location of the environment 
                                        // meta file on the server
                "."                       // location of the packed 
                                        // environment on the server
            );

            // now we can use pyjs
            console.log(pyjs);  
            pyjs.eval("print('hello world')");
            pyjs.exec(`
import praylib as pray
import pyjs
import itertools

win_size = (800, 600)
pray.init_window(*win_size, "Praylib Window")

class MouseTrace:
    def __init__(self):
        self.all_line_strokes = []
        self.line_stroke = []
        self.max_age = 0.5
        self.base_radius = 15.0
        self.zoom = 1.0

    def age_to_radius(self, age):
        # linear interpolation between base_radius and 0
        rel_age = age / self.max_age
        return self.base_radius * (1.0 - rel_age)

    def age_to_color(self, age):
        rel_age = age / self.max_age
        return pray.Color(
            int(255 * (1.0 - rel_age)),
            int(255 * rel_age),
            0,
            255
        )
    def __call__(self, dt):



        # zoom on mousewheel
        if pray.get_mouse_wheel_move() != 0:
            self.zoom += pray.get_mouse_wheel_move() * 0.1
            self.zoom = max(0.1, min(self.zoom, 10.0))

        with pray.drawing_ctx():  

            camera = pray.Camera2D()
            camera.zoom = self.zoom

            with pray.mode_2d_ctx(camera):
             

                pray.clear_background(pray.Color(255, 255, 255, 255))
                screen_pos = pray.get_mouse_position()
                pos = pray.get_screen_to_world_2d(screen_pos, camera)


                if pray.is_mouse_button_down(0):
                    delta = pray.get_mouse_delta().length()
                    if delta > 0.0:
                        now = pray.get_time()
                        self.line_stroke.append((pos, now))
                    
                if pray.is_mouse_button_released(0):
                    self.all_line_strokes.append(self.line_stroke)
                    self.line_stroke = []
                



                new_all_strokes = []

                for strokes in itertools.chain(self.all_line_strokes, [self.line_stroke]):
                    new_strokes = []
                    last_point = None
                    for point, time in strokes:
                        age = pray.get_time() - time
                        if age < self.max_age:
                            radius = self.age_to_radius(age)
                            color = self.age_to_color(age)
                            pray.draw_circle_v(point, radius, color)    
                            new_strokes.append((point, time))
                            if last_point is not None:
                                pray.draw_line_ex(last_point, point, radius * 2, color)
                            last_point = point
                    if new_strokes:
                        new_all_strokes.append(new_strokes)
            

            # Draw the FPS counter
            pray.draw_fps(10, 10)
example = MouseTrace()
pyjs.set_main_loop_callback(example,0)

`)
        }
        runPyjs();

        </script>


    </body>
</html>
